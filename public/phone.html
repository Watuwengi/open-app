<!DOCTYPE html>
<html>
<head>
  <title>Auto-Connecting...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; text-align: center; padding: 50px; background: #000; color: white; }
    video { width: 100%; max-width: 600px; border: 2px solid #007bff; border-radius: 12px; }
    .btn { padding: 16px 32px; font-size: 18px; background: #007bff; color: white; border: none; border-radius: 12px; margin: 10px; cursor: pointer; }
    .btn:hover { background: #0056b3; }
    #status { margin: 15px 0; font-size: 16px; }
  </style>
</head>
<body>
  <h2>ðŸ”— Connecting to Laptop...</h2>
  <video id="local" autoplay muted></video>
  <div id="status">Click below to share screen</div>
  <button class="btn" onclick="startSharing()">START SHARING</button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let pc = null;
    let stream = null;

    function startSharing() {
      document.getElementById('status').innerHTML = 'Requesting screen...';
      document.querySelector('button').disabled = true;

      navigator.mediaDevices.getDisplayMedia({ 
        video: { cursor: "always" }, 
        audio: true 
      })
      .then(gotStream)
      .catch(err => {
        document.getElementById('status').innerHTML = 'Permission denied. Try again.';
        document.querySelector('button').disabled = false;
      });
    }

    function gotStream(mediaStream) {
      stream = mediaStream;
      const video = document.getElementById('local');
      video.srcObject = stream;

      pc = new RTCPeerConnection();
      stream.getTracks().forEach(track => pc.addTrack(track, stream));

      pc.createOffer()
        .then(offer => {
          pc.setLocalDescription(offer);
          socket.emit('offer', offer);
        });

      socket.on('answer', answer => {
        pc.setRemoteDescription(answer);
      });

      pc.onicecandidate = e => {
        if (e.candidate) socket.emit('ice', e.candidate);
      };

      document.getElementById('status').innerHTML = 'Connected! Sharing...';
      document.querySelector('button').style.display = 'none';

      // Stop sharing when user stops
      stream.getVideoTracks()[0].addEventListener('ended', () => {
        socket.disconnect();
        document.getElementById('status').innerHTML = 'Sharing stopped.';
      });
    }
  </script>
</body>
</html>
